<!doctype html>

<!-- copied from https://raw.githubusercontent.com/mdn/webassembly-examples/master/understanding-text-format/logger2.html (CC0) -->

<html>

  <head>
    <meta charset="utf-8">
    <title>xDOOM</title>
  </head>

  <body>
    <canvas id="screen" width="320" height="200">This is where the DooM screen should render.</canvas>

    <script>
      var memory = new WebAssembly.Memory({ initial : 86 });

      function consoleLogString(offset, length) {
        var bytes = new Uint8Array(memory.buffer, offset, length);
        var string = new TextDecoder('utf8').decode(bytes);
        console.log(string);
      }

      // Implement libC `gettimeofday`.
      //
      // This is one of the few functions where we need support from JavaScript,
      // since WebAssembly does not know about the date or about wall-clock
      // timers in general.
      //
      // Doom uses `gettimeofday` to compute when its "ticks" are happening, so
      // the game runs at the same speed on slow as well as on fast hardware.
      function  GetTimeOfDay(ptr) {
        var timeval = new Uint32Array(memory.buffer, ptr, 2);
        // TODO: maybe wait for animation frame?
        let t = new Date();
        timeval[0] = t.getSeconds();
        timeval[1] = t.getMilliseconds() * 1000; // as usec YOLO; Doom wants 1/70th second tics, so we should be fine.
      }

      // Render Doom screen

      const canvas = document.getElementById('screen');
      const doom_screen_width = 320;
      const doom_screen_height = 200;

      function DrawCanvas(ptr) {
        console.log("DrawCanvas - ptr:", ptr);
        var doom_screen = new Uint8Array(memory.buffer, ptr, doom_screen_width*doom_screen_height);
        var ctx = canvas.getContext('2d');
        var render_screen = ctx.createImageData(doom_screen_width, doom_screen_height);

        for (i=0; i < doom_screen_width*doom_screen_height; ++i) {
          render_screen.data[i*4 +0] = doom_screen[i]; // red
          render_screen.data[i*4 +1] = 42; // green
          render_screen.data[i*4 +2] = 42; // blue
          render_screen.data[i*4 +3] = 255; // alpha
        }

        ctx.putImageData(render_screen, 0, 0);
      }

      // WebAssembly specific stuffs

      var importObject = {
        js: {
          console_log: consoleLogString,
          js_timeofday: GetTimeOfDay,
          js_draw_screen: DrawCanvas,
        },
        env: {
          memory: memory
        }
      };

      WebAssembly.instantiateStreaming(fetch('xdoom.wasm'), importObject)
        .then(obj => {
          obj.instance.exports.main();
        });
    </script>
  </body>

</html>